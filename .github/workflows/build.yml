name: ğŸ—ï¸ æ„å»ºè·¨å¹³å°åº”ç”¨

on:
  push:
    branches: [main, master]
    tags: ["v*"]
  pull_request:
    branches: [main, master]
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  build:
    runs-on: ${{ matrix.os }}

    strategy:
      matrix:
        include:
          - os: windows-latest
            platform: windows
            build_script: yarn build-win
            artifact_pattern: "dist/*.exe"
            artifact_name: windows-installer

          - os: macos-latest
            platform: macos
            build_script: yarn build-mac
            artifact_pattern: "dist/*.dmg"
            artifact_name: macos-installer

          - os: ubuntu-latest
            platform: linux
            build_script: yarn build-linux
            artifact_pattern: "dist/*.AppImage"
            artifact_name: linux-appimage

    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ğŸŸ¢ è®¾ç½®Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"
          cache: "yarn"

      - name: ğŸ è®¾ç½®Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: ğŸ“¦ å®‰è£…Node.jsä¾èµ–
        run: yarn install --frozen-lockfile

      - name: ğŸ å®‰è£…Pythonä¾èµ–
        run: |
          cd python-backend
          pip install -r requirements.txt
          cd ..

          - name: ğŸ”§ å‡†å¤‡æ„å»ºç¯å¢ƒ
      run: node build-setup.js

    - name: ğŸ–¼ï¸ ä¿®å¤å›¾æ ‡é…ç½®
      run: node scripts/fix-icons.js

          - name: ğŸ ç”ŸæˆMacå›¾æ ‡ (ä»…macOS)
      if: matrix.platform == 'macos'
      run: |
        if [ ! -f "assets/icon.icns" ]; then
          echo "æ­£åœ¨æ£€æŸ¥PNGå›¾æ ‡æ–‡ä»¶..."
          
          # æ£€æŸ¥icon.pngæ–‡ä»¶æ˜¯å¦å­˜åœ¨ä¸”æœ‰æ•ˆ
          if [ -f "assets/icon.png" ]; then
            # æ£€æŸ¥æ–‡ä»¶å¤§å°ï¼ˆå°äº1KBå¯èƒ½æ˜¯æ— æ•ˆæ–‡ä»¶ï¼‰
            file_size=$(stat -f%z "assets/icon.png" 2>/dev/null || stat -c%s "assets/icon.png" 2>/dev/null || echo "0")
            echo "å›¾æ ‡æ–‡ä»¶å¤§å°: ${file_size} å­—èŠ‚"
            
            if [ "$file_size" -gt 1000 ]; then
              echo "å¼€å§‹ç”ŸæˆMacå›¾æ ‡..."
              mkdir -p tmp.iconset
              
              # ä½¿ç”¨é”™è¯¯å¤„ç†ç”Ÿæˆä¸åŒå°ºå¯¸çš„å›¾æ ‡
              if sips -z 16 16 assets/icon.png --out tmp.iconset/icon_16x16.png 2>/dev/null && \
                 sips -z 32 32 assets/icon.png --out tmp.iconset/icon_16x16@2x.png 2>/dev/null && \
                 sips -z 32 32 assets/icon.png --out tmp.iconset/icon_32x32.png 2>/dev/null && \
                 sips -z 64 64 assets/icon.png --out tmp.iconset/icon_32x32@2x.png 2>/dev/null && \
                 sips -z 128 128 assets/icon.png --out tmp.iconset/icon_128x128.png 2>/dev/null && \
                 sips -z 256 256 assets/icon.png --out tmp.iconset/icon_128x128@2x.png 2>/dev/null && \
                 sips -z 256 256 assets/icon.png --out tmp.iconset/icon_256x256.png 2>/dev/null && \
                 sips -z 512 512 assets/icon.png --out tmp.iconset/icon_256x256@2x.png 2>/dev/null && \
                 sips -z 512 512 assets/icon.png --out tmp.iconset/icon_512x512.png 2>/dev/null && \
                 sips -z 1024 1024 assets/icon.png --out tmp.iconset/icon_512x512@2x.png 2>/dev/null; then
                
                # ç”Ÿæˆicnsæ–‡ä»¶
                if iconutil -c icns tmp.iconset -o assets/icon.icns 2>/dev/null; then
                  echo "âœ… Macå›¾æ ‡ç”ŸæˆæˆåŠŸ"
                else
                  echo "âš ï¸ iconutilå¤±è´¥ï¼Œå°†ä½¿ç”¨é»˜è®¤å›¾æ ‡"
                fi
              else
                echo "âš ï¸ sipså‘½ä»¤å¤±è´¥ï¼ŒPNGæ–‡ä»¶å¯èƒ½æ— æ•ˆï¼Œå°†ä½¿ç”¨é»˜è®¤å›¾æ ‡"
              fi
              
              # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
              rm -rf tmp.iconset
            else
              echo "âš ï¸ PNGå›¾æ ‡æ–‡ä»¶å¤ªå°æˆ–æ— æ•ˆï¼ˆ${file_size}å­—èŠ‚ï¼‰ï¼Œå°†ä½¿ç”¨é»˜è®¤å›¾æ ‡"
            fi
          else
            echo "âš ï¸ PNGå›¾æ ‡æ–‡ä»¶ä¸å­˜åœ¨ï¼Œå°†ä½¿ç”¨é»˜è®¤å›¾æ ‡"
          fi
          
          # å¦‚æœå›¾æ ‡ç”Ÿæˆå¤±è´¥ï¼Œç»§ç»­æ„å»ºï¼ˆä½¿ç”¨é»˜è®¤å›¾æ ‡ï¼‰
          if [ ! -f "assets/icon.icns" ]; then
            echo "â„¹ï¸ å°†ä½¿ç”¨Electroné»˜è®¤å›¾æ ‡è¿›è¡Œæ„å»º"
          fi
        else
          echo "âœ… Macå›¾æ ‡æ–‡ä»¶å·²å­˜åœ¨"
        fi

      - name: ğŸªŸ ç”ŸæˆWindowså›¾æ ‡ (ä»…Windows)
        if: matrix.platform == 'windows'
        run: |
          # è¿™é‡Œå¯ä»¥æ·»åŠ Windowså›¾æ ‡ç”Ÿæˆé€»è¾‘
          # æš‚æ—¶è·³è¿‡ï¼Œä½¿ç”¨é»˜è®¤å›¾æ ‡
          echo "ä½¿ç”¨é»˜è®¤Windowså›¾æ ‡"

      - name: ğŸ—ï¸ æ„å»ºåº”ç”¨ (${{ matrix.platform }})
        run: ${{ matrix.build_script }}

      - name: ğŸ“ åˆ—å‡ºæ„å»ºäº§ç‰©
        shell: bash
        run: |
          echo "æ„å»ºäº§ç‰©åˆ—è¡¨ï¼š"
          ls -la dist/ || echo "distç›®å½•ä¸å­˜åœ¨"
          echo ""
          echo "æŸ¥æ‰¾æ„å»ºæ–‡ä»¶ï¼š"
          find dist -type f -name "*.exe" -o -name "*.dmg" -o -name "*.AppImage" 2>/dev/null || echo "æœªæ‰¾åˆ°æ„å»ºæ–‡ä»¶"

      - name: ğŸ“¤ ä¸Šä¼ æ„å»ºäº§ç‰©
        uses: actions/upload-artifact@v4
        if: success()
        with:
          name: ${{ matrix.artifact_name }}
          path: ${{ matrix.artifact_pattern }}
          retention-days: 30

  # åˆ›å»ºReleaseï¼ˆä»…åœ¨æ‰“tagæ—¶ï¼‰
  release:
    needs: build
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')

    steps:
      - name: ğŸ“¥ ä¸‹è½½æ‰€æœ‰æ„å»ºäº§ç‰©
        uses: actions/download-artifact@v4
        with:
          path: artifacts/
          merge-multiple: true

      - name: ğŸ“ åˆ—å‡ºä¸‹è½½çš„æ–‡ä»¶
        run: |
          echo "ä¸‹è½½çš„æ„å»ºäº§ç‰©ï¼š"
          find artifacts -type f -exec ls -la {} \;

      - name: ğŸš€ åˆ›å»ºRelease
        uses: softprops/action-gh-release@v2
        with:
          files: |
            artifacts/*
          draft: false
          prerelease: false
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # æ„å»ºçŠ¶æ€é€šçŸ¥
  notify:
    needs: [build, release]
    runs-on: ubuntu-latest
    if: always()

    steps:
      - name: ğŸ“Š æ„å»ºçŠ¶æ€æ±‡æ€»
        run: |
          echo "æ„å»ºçŠ¶æ€æ±‡æ€»ï¼š"
          echo "Build job: ${{ needs.build.result }}"
          echo "Release job: ${{ needs.release.result }}"

          if [ "${{ needs.build.result }}" == "success" ]; then
            echo "âœ… æ‰€æœ‰å¹³å°æ„å»ºæˆåŠŸ"
          else
            echo "âŒ æ„å»ºè¿‡ç¨‹ä¸­å‡ºç°é—®é¢˜"
          fi
