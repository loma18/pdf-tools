name: ğŸ—ï¸ æ„å»ºè·¨å¹³å°åº”ç”¨ (åµŒå…¥å¼Python)

on:
  push:
    branches: [ main, master ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  build:
    runs-on: ${{ matrix.os }}
    
    strategy:
      matrix:
        include:
          - os: windows-latest
            platform: windows
            build_script: yarn build-win
            artifact_pattern: "dist/*.exe"
            artifact_name: windows-installer
            
          - os: macos-latest
            platform: macos
            build_script: yarn build-mac
            artifact_pattern: "dist/*.dmg"
            artifact_name: macos-installer
            
          - os: ubuntu-latest
            platform: linux
            build_script: yarn build-linux
            artifact_pattern: "dist/*.AppImage"
            artifact_name: linux-appimage

    steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: ğŸŸ¢ è®¾ç½®Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'yarn'

    - name: ğŸ“¦ å®‰è£…Node.jsä¾èµ–
      run: yarn install --frozen-lockfile

    - name: ğŸ è®¾ç½®åµŒå…¥å¼Pythonç¯å¢ƒ
      run: |
        echo "ğŸ å¼€å§‹è®¾ç½®åµŒå…¥å¼Pythonç¯å¢ƒ..."
        yarn setup-python
        echo "âœ… åµŒå…¥å¼Pythonç¯å¢ƒè®¾ç½®å®Œæˆ (requirements.txt å·²å®‰è£…åˆ°ä¾¿æº Python)"

    - name: ğŸ” éªŒè¯åµŒå…¥å¼Pythonç¯å¢ƒ
      shell: bash
      run: |
        echo "ğŸ” éªŒè¯åµŒå…¥å¼Pythonå®‰è£…..."
        if [ -d "node_modules/@bjia56/portable-python-3.11" ]; then
          echo "âœ… portable-pythonåŒ…å·²å®‰è£…"
          
          # æŸ¥æ‰¾Pythonå¯æ‰§è¡Œæ–‡ä»¶
          if find node_modules/@bjia56/portable-python-3.11 -name "python*" -type f 2>/dev/null | grep -q .; then
            echo "âœ… Pythonå¯æ‰§è¡Œæ–‡ä»¶å·²æ‰¾åˆ°"
            
            # åˆ—å‡ºPythonå¯æ‰§è¡Œæ–‡ä»¶
            echo "ğŸ“ Pythonå¯æ‰§è¡Œæ–‡ä»¶ä½ç½®:"
            find node_modules/@bjia56/portable-python-3.11 -name "python*" -type f 2>/dev/null | head -5
          else
            echo "âš ï¸ æœªæ‰¾åˆ°Pythonå¯æ‰§è¡Œæ–‡ä»¶"
          fi
        else
          echo "âŒ portable-pythonåŒ…æœªæ‰¾åˆ°"
          exit 1
        fi

    - name: ğŸ”§ å‡†å¤‡æ„å»ºç¯å¢ƒ
      run: node build-setup.js

    - name: ğŸ–¼ï¸ ä¿®å¤å›¾æ ‡é…ç½®
      run: node scripts/fix-icons.js

    - name: ğŸ ç”ŸæˆMacå›¾æ ‡ (ä»…macOS)
      if: matrix.platform == 'macos'
      run: |
        if [ ! -f "assets/icon.icns" ]; then
          echo "æ­£åœ¨æ£€æŸ¥PNGå›¾æ ‡æ–‡ä»¶..."
          
          # æ£€æŸ¥icon.pngæ–‡ä»¶æ˜¯å¦å­˜åœ¨ä¸”æœ‰æ•ˆ
          if [ -f "assets/icon.png" ]; then
            # æ£€æŸ¥æ–‡ä»¶å¤§å°ï¼ˆå°äº1KBå¯èƒ½æ˜¯æ— æ•ˆæ–‡ä»¶ï¼‰
            file_size=$(stat -f%z "assets/icon.png" 2>/dev/null || stat -c%s "assets/icon.png" 2>/dev/null || echo "0")
            echo "å›¾æ ‡æ–‡ä»¶å¤§å°: ${file_size} å­—èŠ‚"
            
            if [ "$file_size" -gt 1000 ]; then
              echo "å¼€å§‹ç”ŸæˆMacå›¾æ ‡..."
              mkdir -p tmp.iconset
              
              # ä½¿ç”¨é”™è¯¯å¤„ç†ç”Ÿæˆä¸åŒå°ºå¯¸çš„å›¾æ ‡
              if sips -z 16 16 assets/icon.png --out tmp.iconset/icon_16x16.png 2>/dev/null && \
                 sips -z 32 32 assets/icon.png --out tmp.iconset/icon_16x16@2x.png 2>/dev/null && \
                 sips -z 32 32 assets/icon.png --out tmp.iconset/icon_32x32.png 2>/dev/null && \
                 sips -z 64 64 assets/icon.png --out tmp.iconset/icon_32x32@2x.png 2>/dev/null && \
                 sips -z 128 128 assets/icon.png --out tmp.iconset/icon_128x128.png 2>/dev/null && \
                 sips -z 256 256 assets/icon.png --out tmp.iconset/icon_128x128@2x.png 2>/dev/null && \
                 sips -z 256 256 assets/icon.png --out tmp.iconset/icon_256x256.png 2>/dev/null && \
                 sips -z 512 512 assets/icon.png --out tmp.iconset/icon_256x256@2x.png 2>/dev/null && \
                 sips -z 512 512 assets/icon.png --out tmp.iconset/icon_512x512.png 2>/dev/null && \
                 sips -z 1024 1024 assets/icon.png --out tmp.iconset/icon_512x512@2x.png 2>/dev/null; then
                
                # ç”Ÿæˆicnsæ–‡ä»¶
                if iconutil -c icns tmp.iconset -o assets/icon.icns 2>/dev/null; then
                  echo "âœ… Macå›¾æ ‡ç”ŸæˆæˆåŠŸ"
                else
                  echo "âš ï¸ iconutilå¤±è´¥ï¼Œå°†ä½¿ç”¨é»˜è®¤å›¾æ ‡"
                fi
              else
                echo "âš ï¸ sipså‘½ä»¤å¤±è´¥ï¼ŒPNGæ–‡ä»¶å¯èƒ½æ— æ•ˆï¼Œå°†ä½¿ç”¨é»˜è®¤å›¾æ ‡"
              fi
              
              # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
              rm -rf tmp.iconset
            else
              echo "âš ï¸ PNGå›¾æ ‡æ–‡ä»¶å¤ªå°æˆ–æ— æ•ˆï¼ˆ${file_size}å­—èŠ‚ï¼‰ï¼Œå°†ä½¿ç”¨é»˜è®¤å›¾æ ‡"
            fi
          else
            echo "âš ï¸ PNGå›¾æ ‡æ–‡ä»¶ä¸å­˜åœ¨ï¼Œå°†ä½¿ç”¨é»˜è®¤å›¾æ ‡"
          fi
          
          # å¦‚æœå›¾æ ‡ç”Ÿæˆå¤±è´¥ï¼Œç»§ç»­æ„å»ºï¼ˆä½¿ç”¨é»˜è®¤å›¾æ ‡ï¼‰
          if [ ! -f "assets/icon.icns" ]; then
            echo "â„¹ï¸ å°†ä½¿ç”¨Electroné»˜è®¤å›¾æ ‡è¿›è¡Œæ„å»º"
          fi
        else
          echo "âœ… Macå›¾æ ‡æ–‡ä»¶å·²å­˜åœ¨"
        fi

    - name: ğŸªŸ ç”ŸæˆWindowså›¾æ ‡ (ä»…Windows)
      if: matrix.platform == 'windows'
      run: |
        # è¿™é‡Œå¯ä»¥æ·»åŠ Windowså›¾æ ‡ç”Ÿæˆé€»è¾‘
        # æš‚æ—¶è·³è¿‡ï¼Œä½¿ç”¨é»˜è®¤å›¾æ ‡
        echo "ä½¿ç”¨é»˜è®¤Windowså›¾æ ‡"

    - name: ğŸ—ï¸ æ„å»ºåº”ç”¨ (${{ matrix.platform }})
      env:
        GH_TOKEN: ${{ secrets.BUILDACTION }}
      run: ${{ matrix.build_script }}

    - name: ğŸ“ åˆ—å‡ºæ„å»ºäº§ç‰©
      shell: bash
      run: |
        echo "æ„å»ºäº§ç‰©åˆ—è¡¨ï¼š"
        ls -la dist/ || echo "distç›®å½•ä¸å­˜åœ¨"
        echo ""
        echo "æŸ¥æ‰¾æ„å»ºæ–‡ä»¶ï¼š"
        find dist -type f -name "*.exe" -o -name "*.dmg" -o -name "*.AppImage" 2>/dev/null || echo "æœªæ‰¾åˆ°æ„å»ºæ–‡ä»¶"

    - name: ğŸ“¤ ä¸Šä¼ æ„å»ºäº§ç‰©
      uses: actions/upload-artifact@v4
      if: success()
      with:
        name: ${{ matrix.artifact_name }}
        path: ${{ matrix.artifact_pattern }}
        retention-days: 30

  # æ„å»ºçŠ¶æ€é€šçŸ¥
  notify:
    needs: build
    runs-on: ubuntu-latest
    if: always()
    
    steps:
    - name: ğŸ“Š æ„å»ºçŠ¶æ€æ±‡æ€»
      run: |
        echo "ğŸ åµŒå…¥å¼Pythonæ„å»ºçŠ¶æ€æ±‡æ€»ï¼š"
        echo "Build job: ${{ needs.build.result }}"
        
        if [ "${{ needs.build.result }}" == "success" ]; then
          echo "âœ… æ‰€æœ‰å¹³å°æ„å»ºæˆåŠŸ (åŒ…å«åµŒå…¥å¼Pythonç¯å¢ƒ)"
          echo "ğŸ“¦ æ„å»ºäº§ç‰©åŒ…å«:"
          echo "   - Electronåº”ç”¨ç¨‹åº"
          echo "   - åµŒå…¥å¼Python 3.11è¿è¡Œæ—¶"
          echo "   - requirements.txt ä¸­çš„ä¾èµ–ï¼ˆå¦‚ PyMuPDFã€python-dotenvã€requests ç­‰ï¼‰"
          echo "   - é›¶ä¾èµ–å®‰è£…ï¼Œå¼€ç®±å³ç”¨"
          if [[ "${{ github.ref }}" == refs/tags/v* ]]; then
            echo "ğŸš€ å·²è‡ªåŠ¨å‘å¸ƒåˆ°GitHub Releases"
          fi
        else
          echo "âŒ æ„å»ºè¿‡ç¨‹ä¸­å‡ºç°é—®é¢˜"
          echo "ğŸ’¡ å¯èƒ½çš„åŸå› :"
          echo "   - åµŒå…¥å¼Pythonä¸‹è½½å¤±è´¥"
          echo "   - ä¾èµ–å®‰è£…ç½‘ç»œé—®é¢˜"
          echo "   - electron-builderé…ç½®é—®é¢˜"
        fi
